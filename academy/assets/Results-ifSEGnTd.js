import{j as e}from"./state-DF3Lb9FH.js";import{h as Z,c as ee,u as se,b as o}from"./react-BdkzLz8Q.js";import{c as R,u as te,S as O,e as f}from"./index-DNjlxgt7.js";import{u as I,T as ae,a as re}from"./progressStore-BkQjSStB.js";import{A as ne}from"./award-C9po3OYb.js";import{B as le,D as ce}from"./download-MNUosWjF.js";import{C as oe}from"./circle-check-rgw7XaYp.js";import{C as ie,L as de}from"./lightbulb-Cq2HlIaG.js";const xe=[["path",{d:"M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z",key:"18887p"}]],U=R("message-square",xe);const me=[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]],pe=R("refresh-cw",me);const ue=[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]],he=R("search",ue),ke=()=>{const{testId:c}=Z(),u=ee(),Q=se(),S=I(s=>s.updateProgress),D=I(s=>s.addTestId),j=te(s=>s.selectedExam),[r,B]=o.useState(null),[b,F]=o.useState(!0),[C,M]=o.useState(!1),[T,E]=o.useState(!1),[L,G]=o.useState(null),q=o.useRef(!1);o.useEffect(()=>{u.state&&sessionStorage.setItem(`test_result_${c}`,JSON.stringify(u.state))},[u.state,c]);const m=o.useMemo(()=>{if(u.state)return u.state;const s=sessionStorage.getItem(`test_result_${c}`);return s?JSON.parse(s):null},[u.state,c]),h=m?.answers||{},N=m?.ai_feedback||null,l=m?.submission||null,J=m?.practiceMode||!1,k=m?.examTrack||null,z=m?.questionTimes||{},H=m?.hintsUsed||[],$=()=>{const s=String(r?.exam_standard||"").toLowerCase();return s==="ncdpi"?String(k||j||"ncdpi").toLowerCase():String(s||j||"ncdpi").toLowerCase()};o.useEffect(()=>{(async()=>{try{const t=await f.get(`/tests/${c}`);B(t.data)}catch(t){console.error("Failed to fetch test",t)}finally{F(!1)}})()},[c]);const g=o.useMemo(()=>{if(typeof l?.score=="number")return Math.round(l.score);if(!r)return 0;const s=r.questions||[];let t=0;s.forEach((a,i)=>{(a.question_type==="mcq"||a.options)&&h[i]===a.correct_answer&&(t+=1)});const n=s.filter(a=>a.question_type==="mcq"||!!a.options).length;return n>0?Math.round(t/n*100):0},[l,r,h]);o.useEffect(()=>{if(r&&!b){const s=$();S(r.subject,g,r.questions?.length||0,s)}},[r,b,g,S,k,j]),o.useEffect(()=>{if(!r||!l||b||q.current)return;q.current=!0,(async()=>{const t=r.questions||[],n=l.ai_feedback?.evaluations||[];for(let a=0;a<t.length;a++){const i=t[a],p=i.concept_ids?.[0];if(!p)continue;const x=n.find(y=>y.index===a+1),v=i.question_type==="mcq"||!!i.options?h[a]===i.correct_answer:(x?.score??0)>=.7;try{await f.post("/learning/mastery/update",{test_id:c,concept_id:p,is_correct:v,time_taken_seconds:z[a]||30,had_hint:H.includes(a)})}catch{}}try{const a=await f.get(`/learning/mastery/summary/${c}`);G(Math.round((a.data.overall_mastery||0)*100))}catch{}D(c,$())})()},[r,l,b,k,j]);const K=async()=>{M(!0);try{const s=await f.post(`/reports/${c}/results/download`,{score:g,feedback:N?.overall_summary||"Good effort!",answers:h},{responseType:"blob"}),t=window.URL.createObjectURL(new Blob([s.data])),n=document.createElement("a");n.href=t,n.setAttribute("download",`Report_${r.title}.pdf`),document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(t)}catch(s){console.error("Download failed",s),alert("Could not generate the report. Please try again.")}finally{M(!1)}},V=async()=>{E(!0);try{const s={answers:h},t=l?.learning_plan?.next_session?.recommended_question_count;typeof t=="number"&&(s.question_count=t);const n=await f.post(`/tests/${c}/adaptive-retest`,s);Q(`/take/${n.data.id}`,{state:{practiceMode:!0,adaptiveRetest:!0,previousTestId:c}})}catch(s){console.error("Adaptive retest generation failed",s),alert("Could not generate adaptive retest. Please try again.")}finally{E(!1)}};if(b)return e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh] space-y-4",children:[e.jsx("div",{className:"w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin"}),e.jsx("p",{className:"text-slate-400",children:"Loading your performance report..."})]});if(!r)return e.jsx("div",{children:"Test not found"});const P=r.questions||[],d=l?.learning_plan,_=l?.quality_check||r?.quality_check||null,w=l?.coverage_summary||r?.coverage_summary||null,W=(l?.exam_standard||r?.exam_standard||"ncdpi").toString().toLowerCase(),X={ncdpi:"NCEOG Readiness",sat:"SAT Readiness",act:"ACT Readiness",neet:"NEET Readiness",jee:"JEE Readiness",cbse:"CBSE Readiness",icse:"ICSE Readiness",tn_govt:"TN State Readiness"},Y=g>=80?"Ready":g>=60?"On Track":"Needs Reinforcement";return e.jsxs("div",{className:"max-w-5xl mx-auto space-y-12 py-4 animate-in fade-in duration-700",children:[e.jsxs("div",{className:"bg-white rounded-[2.5rem] border border-slate-200 p-10 sm:p-14 text-center space-y-10 relative overflow-hidden shadow-xl shadow-slate-100/50",children:[e.jsx("div",{className:"absolute top-0 left-0 w-full h-2 bg-indigo-600"}),e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"inline-flex items-center justify-center p-6 bg-indigo-50 rounded-full border border-indigo-100 mb-2",children:e.jsx(ne,{className:"w-16 h-16 text-indigo-600"})}),J&&e.jsx("div",{className:"px-4 py-1 bg-emerald-50 text-emerald-600 border border-emerald-100 rounded-full text-xs font-black uppercase tracking-widest",children:"Practice Session"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h1",{className:"text-4xl sm:text-5xl font-black text-slate-900 tracking-tight",children:"Performance Report"}),e.jsx("p",{className:"text-slate-500 font-bold text-lg",children:r.title})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8 max-w-3xl mx-auto",children:[e.jsxs("div",{className:"p-8 bg-slate-50 rounded-3xl border border-slate-100 flex flex-col items-center justify-center space-y-3 transition-transform hover:scale-[1.02]",children:[e.jsx("div",{className:"p-3 bg-white rounded-2xl border border-slate-100 shadow-sm",children:e.jsx(ae,{className:"w-8 h-8 text-indigo-600"})}),e.jsxs("p",{className:"text-5xl font-black text-slate-900 tracking-tighter",children:[g,"%"]}),e.jsx("p",{className:"text-xs text-slate-400 uppercase tracking-widest font-black",children:"Overall Score"})]}),e.jsxs("div",{className:"p-8 bg-slate-50 rounded-3xl border border-slate-100 flex flex-col items-center justify-center space-y-3 transition-transform hover:scale-[1.02]",children:[e.jsx("div",{className:"p-3 bg-white rounded-2xl border border-slate-100 shadow-sm",children:e.jsx(le,{className:"w-8 h-8 text-indigo-600"})}),e.jsx("p",{className:"text-3xl font-black text-slate-900",children:Y}),e.jsx("p",{className:"text-xs text-slate-400 uppercase tracking-widest font-black",children:X[W]||"Exam Readiness"})]})]}),typeof l?.open_ended_score=="number"&&e.jsxs("div",{className:"text-sm text-slate-500 font-semibold",children:["Open-ended rubric score: ",Math.round(l.open_ended_score),"%"]}),L!==null&&e.jsxs("div",{className:"inline-flex items-center gap-2 px-4 py-2 bg-emerald-50 border border-emerald-100 rounded-full text-sm font-bold text-emerald-700",children:[e.jsx(re,{className:"w-4 h-4"}),"Concept Mastery: ",L,"%"]}),_&&e.jsxs("div",{className:`inline-flex items-center gap-2 px-4 py-2 rounded-full text-sm font-bold border ${_.status==="pass"?"bg-emerald-50 border-emerald-100 text-emerald-700":"bg-amber-50 border-amber-100 text-amber-700"}`,children:[e.jsx(O,{className:"w-4 h-4"}),"Question Quality Check: ",_.status==="pass"?"Pass":"Review"]}),w&&e.jsxs("div",{className:"w-full max-w-3xl mx-auto bg-slate-50 border border-slate-100 rounded-2xl p-5 text-left space-y-2",children:[e.jsx("p",{className:"text-xs font-black uppercase tracking-widest text-slate-500",children:"Coverage Summary"}),e.jsxs("p",{className:"text-sm text-slate-700 font-semibold",children:["Total questions: ",w.total_questions||P.length]}),!!w.top_concepts?.length&&e.jsxs("p",{className:"text-xs text-slate-600",children:["Top concepts: ",w.top_concepts.map(s=>`${s.concept} (${s.count})`).join(", ")]})]}),N?.overall_summary&&e.jsxs("div",{className:"bg-indigo-50/50 border border-indigo-100 p-8 rounded-3xl text-left space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 text-indigo-600 font-black uppercase tracking-widest text-xs",children:[e.jsx(O,{className:"w-5 h-5"}),"Learning Insight"]}),e.jsxs("p",{className:"text-slate-700 leading-relaxed italic text-lg font-medium",children:['"',N.overall_summary,'"']})]}),e.jsxs("div",{className:"flex flex-wrap justify-center gap-4 pt-6",children:[e.jsxs("button",{onClick:K,disabled:C,className:"flex items-center gap-3 px-8 py-4 bg-indigo-600 text-white hover:bg-indigo-700 rounded-2xl font-black transition-all shadow-xl shadow-indigo-100 disabled:opacity-50",children:[e.jsx(ce,{className:"w-5 h-5"}),C?"Generating PDF...":"Export Report"]}),e.jsxs("button",{onClick:V,disabled:T,className:"flex items-center gap-3 px-8 py-4 bg-amber-500 text-white hover:bg-amber-600 rounded-2xl font-black transition-all shadow-xl shadow-amber-100 disabled:opacity-50",children:[e.jsx(pe,{className:"w-5 h-5"}),T?"Building Adaptive Retest...":"Start Adaptive Retest"]})]})]}),d&&e.jsxs("div",{className:"bg-white rounded-[2rem] border border-slate-200 p-8 sm:p-10 shadow-xl shadow-slate-100/50 space-y-8",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-2xl font-black text-slate-900 tracking-tight",children:"Personal Learning Plan"}),e.jsx("p",{className:"text-slate-500 font-medium",children:"Use this focused plan to convert this attempt into measurable progress."})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-emerald-50 border border-emerald-100 rounded-2xl p-6 space-y-4",children:[e.jsx("p",{className:"text-xs font-black uppercase tracking-widest text-emerald-700",children:"Strengths to Keep"}),d.strengths?.length?e.jsx("div",{className:"space-y-3",children:d.strengths.map((s,t)=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-emerald-100",children:[e.jsxs("p",{className:"text-sm font-black text-slate-900",children:["Q",s.question_index," · ",s.concept]}),e.jsx("p",{className:"text-xs text-slate-600 mt-1",children:s.objective})]},t))}):e.jsx("p",{className:"text-sm text-slate-600",children:"Keep building consistency across all standards."})]}),e.jsxs("div",{className:"bg-amber-50 border border-amber-100 rounded-2xl p-6 space-y-4",children:[e.jsx("p",{className:"text-xs font-black uppercase tracking-widest text-amber-700",children:"Focus Areas"}),d.focus_areas?.length?e.jsx("div",{className:"space-y-3",children:d.focus_areas.map((s,t)=>e.jsxs("div",{className:"bg-white rounded-xl p-4 border border-amber-100",children:[e.jsxs("p",{className:"text-sm font-black text-slate-900",children:["Q",s.question_index," · ",s.concept]}),e.jsx("p",{className:"text-xs text-slate-600 mt-1",children:s.recommended_action||s.objective}),s.misconception&&e.jsxs("p",{className:"text-xs text-rose-600 mt-1",children:["Watch for: ",s.misconception]})]},t))}):e.jsx("p",{className:"text-sm text-slate-600",children:"No critical gaps detected in this attempt."})]})]}),e.jsxs("div",{className:"bg-slate-50 border border-slate-100 rounded-2xl p-6",children:[e.jsx("p",{className:"text-xs font-black uppercase tracking-widest text-slate-600 mb-3",children:"Next Session Recommendation"}),e.jsxs("p",{className:"text-sm text-slate-700 font-semibold",children:["Practice ",d.next_session?.recommended_question_count||10," questions in"," ",e.jsx("span",{className:"text-indigo-600",children:d.next_session?.suggested_mode||"practice"})," mode focused on: ",(d.next_session?.target_concepts||[]).join(", ")||"core exam skills","."]})]})]}),e.jsxs("div",{className:"space-y-8 px-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("h2",{className:"text-2xl font-black text-slate-900 tracking-tight flex items-center gap-3",children:[e.jsx(he,{className:"w-6 h-6 text-slate-400"}),"Detailed Analysis"]})}),e.jsx("div",{className:"space-y-8",children:P.map((s,t)=>{const n=N?.evaluations?.find(x=>x.index===t+1),a=s.question_type==="mcq"||!!s.options,i=h[t],p=a?i===s.correct_answer:(n?.score??0)>=.8;return e.jsxs("div",{className:`p-8 sm:p-10 bg-white rounded-[2rem] border-2 ${p?"border-emerald-100 shadow-emerald-50/50":"border-rose-100 shadow-rose-50/50"} space-y-8 shadow-xl transition-all hover:scale-[1.01]`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:`px-2.5 py-1 rounded-lg font-black text-xs ${p?"bg-emerald-100 text-emerald-700":"bg-rose-100 text-rose-700"}`,children:["Q",t+1]}),e.jsx("span",{className:"text-[10px] font-black text-slate-400 uppercase tracking-widest",children:a?"Multiple Choice":"Open Response"})]}),e.jsx("h3",{className:"text-xl sm:text-2xl font-bold text-slate-900 leading-tight tracking-tight",children:s.question_text})]}),e.jsx("div",{className:`p-3 rounded-2xl ${p?"bg-emerald-50":"bg-rose-50"}`,children:p?e.jsx(oe,{className:"w-8 h-8 text-emerald-600 flex-shrink-0"}):e.jsx(ie,{className:"w-8 h-8 text-rose-600 flex-shrink-0"})})]}),a?e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:Object.entries(s.options||{}).map(([x,A])=>{const v=i===x,y=s.correct_answer===x;return e.jsxs("div",{className:`p-5 rounded-2xl text-sm border-2 flex items-center gap-4 transition-all ${y?"bg-emerald-50 border-emerald-200 text-slate-900 font-bold":v?"bg-rose-50 border-rose-200 text-slate-900 font-bold":"bg-slate-50 border-slate-50 text-slate-500"}`,children:[e.jsx("span",{className:`w-8 h-8 rounded-xl flex items-center justify-center font-black text-xs ${y?"bg-emerald-600 text-white":v?"bg-rose-600 text-white":"bg-white border border-slate-200 text-slate-400"}`,children:x}),e.jsx("span",{className:"flex-1",children:A})]},x)})}):e.jsxs("div",{className:"space-y-4 bg-slate-50 p-8 rounded-3xl border border-slate-100",children:[e.jsxs("div",{className:"flex items-center gap-2 text-slate-400 text-[10px] font-black uppercase tracking-widest",children:[e.jsx(U,{className:"w-3 h-3"}),"Student Response"]}),e.jsx("p",{className:"text-slate-700 leading-relaxed font-medium italic text-lg",children:i||"No response provided for this assessment."}),e.jsxs("p",{className:"text-sm text-slate-600",children:[e.jsx("span",{className:"font-bold",children:"Model guidance:"})," ",s.correct_answer]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(n?.feedback||s.explanation_correct||s.explanation)&&e.jsxs("div",{className:"bg-white p-6 rounded-2xl border border-indigo-100 flex gap-5 shadow-sm",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-indigo-50 flex items-center justify-center flex-shrink-0",children:e.jsx(U,{className:"w-5 h-5 text-indigo-600"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[10px] font-black text-indigo-600 uppercase tracking-widest",children:"Educator Feedback"}),e.jsx("p",{className:"text-sm text-slate-600 leading-relaxed font-bold",children:n?.feedback||s.explanation_correct||s.explanation})]})]}),(n?.suggestion||s.hint)&&e.jsxs("div",{className:"bg-white p-6 rounded-2xl border border-amber-100 flex gap-5 shadow-sm",children:[e.jsx("div",{className:"w-10 h-10 rounded-xl bg-amber-50 flex items-center justify-center flex-shrink-0",children:e.jsx(de,{className:"w-5 h-5 text-amber-600"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-[10px] font-black text-amber-600 uppercase tracking-widest",children:"Next Step"}),e.jsx("p",{className:"text-sm text-slate-600 leading-relaxed font-bold",children:n?.suggestion||s.hint})]})]})]})]},t)})})]})]})};export{ke as default};
